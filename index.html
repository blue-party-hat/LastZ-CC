<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Guild Map Helper</title>
  <style>
    /* DARK THEME RESET */
    body { font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; padding: 0; box-sizing: border-box; overflow: hidden; background: #222; color: #eee; }
    
    /* TAB HEADER */
    .tabs { display: flex; background: #333; border-bottom: 2px solid #555; height: 50px; }
    .tab-btn {
      flex: 1; border: none; background: #333; color: #aaa; 
      font-size: 1rem; font-weight: bold; cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .tab-btn:hover { background: #444; color: #fff; }
    .tab-btn.active { background: #222; color: gold; border-bottom: 3px solid gold; }

    /* MAIN CONTENT AREA */
    .tab-content { display: none; height: calc(100vh - 50px); width: 100%; overflow: hidden; }
    .tab-content.active { display: flex; }

    /* TAB 1: SELECTION (Split View) */
    #tab-selection { flex-direction: row; }
    
    #source-panel { 
      width: 40%; height: 100%; padding: 10px; border-right: 2px solid #444; 
      overflow: auto; background: #2a2a2a; display: flex; flex-direction: column; align-items: center; 
    }
    #source-panel img { max-width: 100%; border: 2px solid #444; display: none; cursor: crosshair; margin-top: 10px; }
    
    #groups-panel { 
      width: 60%; height: 100%; padding: 20px; 
      overflow-y: auto; background: #333; display: flex; flex-wrap: wrap; gap: 15px; align-content: flex-start; 
    }
    
    .group-wrapper { width: 48%; display: flex; flex-direction: column; min-height: 200px; }
    .group-header { font-weight: bold; margin-bottom: 5px; font-size: 1.1rem; color: #ccc; }
    
    .group-container { 
      flex: 1; border: 2px dashed #666; background: #444;
      padding: 10px; display: flex; flex-wrap: wrap; gap: 8px; border-radius: 6px; 
    }
    .group-container:hover { border-color: #888; background: #555; }

    /* TAB 2: MAP (Full View) */
    #tab-map { position: relative; background: #111; }
    
    #map-bg { 
      width: 100%; height: 100%; 
      object-fit: contain; object-position: center; 
      display: block; pointer-events: none; 
    }

    /* CARDS */
    .avatar-card { 
      width: 60px; height: 60px; /* Bigger in selection tab */
      aspect-ratio: 1/1; 
      border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.5); 
      cursor: grab; background-position: center; background-size: contain; background-repeat: no-repeat; 
      background-color: #000; border-radius: 6px; position: relative; flex-shrink: 0; 
    }
    .avatar-card:active { cursor: grabbing; border-color: gold; }

    .delete-btn {
      position: absolute; top: -6px; right: -6px; width: 18px; height: 18px;
      background: red; color: white; border-radius: 50%; text-align: center;
      line-height: 16px; font-size: 12px; font-weight: bold; cursor: pointer;
      border: 1px solid white; display: none; z-index: 10;
    }
    .avatar-card:hover .delete-btn { display: block; }

    /* MAP TOKENS */
    .map-group { 
      position: absolute; 
      width: 100px; height: 80px; 
      background: rgba(255, 255, 255, 0.4); 
      border: 3px solid gold; border-radius: 8px; 
      cursor: move; 
      display: grid; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr; 
      gap: 1px; padding: 2px; 
      box-shadow: 0 4px 8px rgba(0,0,0,0.5); 
      z-index: 100; user-select: none; overflow: visible; 
    }

    .mini-avatar { width: 100%; height: 100%; background-size: contain; background-repeat: no-repeat; background-position: center; border-radius: 2px; }
    
    .group-label-overlay {
      position: absolute; top: -24px; left: -10px; 
      background: white; border: 2px solid inherit;
      color: #333; font-weight: bold; font-size: 14px;
      padding: 2px 8px; border-radius: 12px;
      display: flex; justify-content: center; align-items: center;
      z-index: 200; box-shadow: 0 2px 4px rgba(0,0,0,0.5);
      white-space: nowrap;
    }

    /* COLORS */
    #map-group-a { border-color: #e74c3c; background-color: rgba(231, 76, 60, 0.3); }
    #map-group-b { border-color: #3498db; background-color: rgba(52, 152, 219, 0.3); }
    #map-group-c { border-color: #2ecc71; background-color: rgba(46, 204, 113, 0.3); }
    #map-group-d { border-color: #f1c40f; background-color: rgba(241, 196, 15, 0.3); }
    #map-group-y { border-color: #1abc9c; background-color: rgba(26, 188, 156, 0.3); }
    #map-group-z { border-color: #d500f9; background-color: rgba(213, 0, 249, 0.3); }
    
    .group-label-overlay { background: #fff; border-color: inherit; }

    /* UPLOAD BUTTON STYLING */
    .upload-btn-wrapper { margin-bottom: 10px; width: 100%; text-align: center; }
    input[type=file] { color: #eee; }

  </style>
</head>
<body>

  <!-- TAB NAVIGATION -->
  <div class="tabs">
    <button class="tab-btn active" onclick="openTab('tab-selection')">1. Assign Groups</button>
    <button class="tab-btn" onclick="openTab('tab-map')">2. Map Strategy</button>
  </div>

  <!-- TAB 1: SELECTION -->
  <div id="tab-selection" class="tab-content active">
    <div id="source-panel">
      <div class="upload-btn-wrapper">
        <span style="display:block; margin-bottom:5px; color:#aaa;">Step 1: Upload Screenshot</span>
        <input type="file" id="imageLoader" accept="image/*" />
      </div>
      <span id="placeholder-text" style="margin-top:50px; color:#666;">(Screenshot will appear here)</span>
      <img id="sourceImage" alt="Uploaded Screenshot" />
    </div>
    
    <div id="groups-panel">
      <div class="group-wrapper"><div class="group-header">Group A</div><div class="group-container" id="group-a" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
      <div class="group-wrapper"><div class="group-header">Group B</div><div class="group-container" id="group-b" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
      <div class="group-wrapper"><div class="group-header">Group C</div><div class="group-container" id="group-c" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
      <div class="group-wrapper"><div class="group-header">Group D</div><div class="group-container" id="group-d" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
      <div class="group-wrapper"><div class="group-header">Group Y</div><div class="group-container" id="group-y" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
      <div class="group-wrapper"><div class="group-header">Group Z</div><div class="group-container" id="group-z" ondrop="drop(event)" ondragover="allowDrop(event)"></div></div>
    </div>
  </div>

  <!-- TAB 2: MAP -->
  <div id="tab-map" class="tab-content">
    <img id="map-bg" src="map.png" alt="MAP LOADING... (Ensure file is named map.png)" />
    
    <!-- Map Tokens -->
    <div id="map-group-a" class="map-group" style="top: 50px; left: 50px;"><div class="group-label-overlay">A</div></div>
    <div id="map-group-b" class="map-group" style="top: 50px; left: 180px;"><div class="group-label-overlay">B</div></div>
    <div id="map-group-c" class="map-group" style="top: 50px; left: 310px;"><div class="group-label-overlay">C</div></div>
    <div id="map-group-d" class="map-group" style="top: 50px; left: 440px;"><div class="group-label-overlay">D</div></div>
    <div id="map-group-y" class="map-group" style="top: 50px; left: 570px;"><div class="group-label-overlay">Y</div></div>
    <div id="map-group-z" class="map-group" style="top: 50px; left: 700px;"><div class="group-label-overlay">Z</div></div>
  </div>

  <script>
    // TAB LOGIC
    function openTab(tabId) {
      // Hide all contents
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      
      // Show target
      document.getElementById(tabId).classList.add('active');
      
      // Highlight button
      const btnIndex = tabId === 'tab-selection' ? 0 : 1;
      document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');
    }

    const imageLoader = document.getElementById('imageLoader');
    const sourceImage = document.getElementById('sourceImage');
    const placeholderText = document.getElementById('placeholder-text');
    let avatarCount = 0;

    // UPLOAD
    imageLoader.addEventListener('change', function(e) {
      if(!e.target.files || !e.target.files[0]) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        sourceImage.src = event.target.result;
        sourceImage.style.display = 'block';
        placeholderText.style.display = 'none';
      }
      reader.readAsDataURL(e.target.files[0]);
    });

    // CLICK FACE
    sourceImage.addEventListener('click', function(e) {
      if (!sourceImage.src || sourceImage.style.display === 'none') return;

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const size = 180; 
      canvas.width = size; canvas.height = size;
      
      const rect = sourceImage.getBoundingClientRect();
      const scaleX = sourceImage.naturalWidth / rect.width;
      const scaleY = sourceImage.naturalHeight / rect.height;
      const clickX = (e.clientX - rect.left) * scaleX;
      const clickY =
